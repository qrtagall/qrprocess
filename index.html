<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>QRTagall | ID Verifier</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --primary: #005aab;
            --valid: #00cc88;
            --error: #ff4444;
        }



        body {
            margin: 0;
            padding: 0;
            background: #f4f4f4;
            font-family: 'Segoe UI', sans-serif;
            min-height: 100vh;
            display: block;
            overflow-y: auto;

        }

        #popup {
            position: relative;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            text-align: center;
            width: 320px;
            margin: 80px auto; /* this centers it with scroll */
            animation: fadeIn 0.4s ease;
        }


        h2 {
            margin-top: 0;
            color: var(--primary);
        }

        #result {
            font-size: 16px;
            margin-top: 20px;
            font-weight: bold;

        }

        #claimBtn {
            margin-top: 25px;
            display: none;
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #claimBtn:hover {
            background-color: #005fa3;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .login-options {
            margin-top: 25px;
        }

        .login-options p {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .auth-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .auth-button {
            width: 40px;
            height: 40px;
            opacity: 0.3;
            cursor: not-allowed;
            transition: transform 0.2s;
        }

        .auth-button.enabled {
            opacity: 1;
            cursor: pointer;
        }

        .auth-button.enabled:hover {
            transform: scale(1.1);
        }

        .auth-buttons-vertical {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            margin-top: 10px;
        }

        .auth-button-box {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid #ccc;
            background-color: #fff;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            width: 220px;
            justify-content: center;
            cursor: not-allowed;
            opacity: 0.5;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .auth-button-box img.auth-logo {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            object-fit: contain;
        }

        .auth-button-box.enabled {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;                  /* spacing between logo and text */
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            background-color: #0b72b9;
            color: white;
            border-radius: 10px;
            border: none;
            transition: transform 0.2s;
        }

        .auth-button-box.enabled:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        #versionTag {
            font-size: 8px;
            color: #666;
            position: absolute;
            bottom: 12px;
            right: 20px;
            font-family: monospace;
        }

        #mainContent {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 800px;
            margin: 40px auto;
            padding: 30px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        #mainContent h2 {
            color: var(--primary);
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }

        #mainContent p {
            width: 100%;
            font-size: 16px;
            text-align: left;
            margin: 10px 0;
            line-height: 1.5;
        }

        #mainContent iframe,
        #mainContent img {
            max-width: 100%;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin: 20px 0;
        }

        .editBtn {
            transition: all 0.3s ease;
        }

        .disabled-button {
            margin-top: 40px;
            padding: 16px 48px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 12px;
            background-color: #ccc;
            color: #bbb;
            border: none;
            cursor: not-allowed;
            opacity: 0.6;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }

        .enabled {
            background-color: var(--primary);
            color: white;
            cursor: pointer;
            opacity: 1;
            box-shadow: 0 4px 10px rgba(0, 119, 204, 0.2);
            padding: 18px 52px;   /* ‚úÖ new size here */
            font-size: 19px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #assetNameInput {
            font-size: 13px !important;
        }



    </style>
</head>
<body>


<!-- Spinner & Popup -->
<div id="popup">

    <div id="qrImage" style="text-align: center; margin-top: 10px;">
        <canvas id="qrCanvas" style="padding:6px; border:1px solid #ccc; border-radius:8px; background:#fff;"></canvas>
    </div>

    <h3>üîç Verifying QR ID</h3>
    <p id="idText" style="font-size:14px; color:gray;"></p>
    <div id="spinner" style="margin-top:20px;">‚è≥ Please wait...</div>
    <div id="result" style="display:none;"></div>

    <div id="loginSection" class="login-options" style="display:none; font-size:13.5px;">
        <p style="font-weight: normal;">Give Asset Name and "Login" to Own this QR</p>

        <!-- üëá Asset Name Input Box -->
        <input id="assetNameInput" type="text" placeholder="Enter Asset Name"
               style="margin-bottom:10px; padding:8px; width:80%; border-radius:6px; border:1px solid #ccc; " />

        <div class="auth-buttons-vertical">
            <button class="auth-button-box enabled" onclick="googleLoginNew()">
                <img class="auth-logo" src="https://developers.google.com/identity/images/g-logo.png" alt="Google Logo">
                <span>Log-in with Google</span>
            </button>
        </div>
    </div>

    <div id="versionTag"></div>

</div>




<!-- ‚úÖ Then mainContent separately -->
<div id="mainContent" style="display:none; padding:30px; max-width:600px; font-family:'Segoe UI', sans-serif;">

    <!-- Dynamically insert QR Div here later (after tagline) -->

    <h2 id="assetTitle" style="color:var(--primary); font-size:24px;"></h2>

    <div id="assetLinks" style="margin-top:10px;"></div>

    <hr style="border: none; height: 3px; width: 80%; background: linear-gradient(to right, orange, #ffa500); margin: 60px auto 30px auto; border-radius: 5px;">

    <div style="display: flex; justify-content: center; margin-top: 40px;">
        <button id="editBtn" class="enabled" onclick="editAlert()" style="text-align: center; line-height: 1.2;">
            üîê Log-in to Edit Details
        </button>
    </div>

</div>


<div id="ownerConfirmModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:white; padding:30px 25px; border-radius:12px; width:90%; max-width:360px; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.2);">
        <h3 style="margin-top:0; font-size:18px; color:#e67e22;">‚ö†Ô∏è Only QR owner can edit !</h3>
        <p style="margin-bottom:25px; font-size:15px;">Are you the owner - would you like to log in?</p>
        <button id="ownerLoginYes" style="background-color:#005aab; color:white; padding:10px 20px; border:none; border-radius:6px; font-weight:bold; margin-right:10px; cursor:pointer;">Yes, Login</button>
        <button id="ownerLoginCancel" style="background-color:#ccc; color:#333; padding:10px 20px; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">Cancel</button>
    </div>
</div>


<div id="fullScreenSpinner" style="
	  display: none;
	  position: fixed;
	  top: 0; left: 0; right: 0; bottom: 0;
	  background: rgba(255, 255, 255, 0.7);
	  z-index: 9999;
	  justify-content: center;
	  align-items: center;
	">
    <div class="spinner" style="
		border: 8px solid #f3f3f3;
		border-top: 8px solid #3498db;
		border-radius: 50%;
		width: 60px;
		height: 60px;
		animation: spin 1s linear infinite;
	  "></div>
</div>



<button id="logoutBtn" onclick="handleLogout()" style="
	  position: fixed;
	  bottom: 20px;
	  right: 20px;
	  background: #f44336;
	  color: white;
	  border: none;
	  border-radius: 6px;
	  padding: 10px 16px;
	  font-size: 14px;
	  cursor: pointer;
	  display: none; /* Initially hidden */
	  z-index: 999;
	">üîì Log Out</button>




<!-- üî≤ Modal for Adding Artifact -->
<!-- üî≤ Modal for Adding Artifact -->
<div id="addArtifactModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:#00000055; z-index:10000; justify-content:center; align-items:center;">
    <div style="background:white; padding:20px; border-radius:10px; max-width:500px; width:90%; box-shadow:0 0 10px rgba(0,0,0,0.2); position:relative;">
        <h3 id="addArtifactModalTitle">‚ûï Add Artifact Info</h3>

        <!-- ‚úÖ Basic Info Section -->
        <div id="basicInfoSection">
            <label>Basic Info:</label><br>
            <input type="text" id="artifactBasicInfo" style="width:100%; margin-bottom:10px;"><br>
        </div>

        <!-- ‚úÖ File Type Section -->
        <div id="fileTypeSection">
            <label>File Type:</label><br>
            <select id="artifactFileType" style="width:100%; margin-bottom:10px;" onchange="onFileTypeChange()">
                <option value="TEXT">TEXT</option>
                <option value="IMAGEFILE">IMAGEFILE</option>
                <option value="PDFFILE">PDFFILE</option>
                <option value="AUDIOFILE">AUDIOFILE</option>
                <option value="VIDEOFILE">VIDEOFILE</option>
            </select><br>
        </div>

        <!-- ‚úÖ Visibility Section -->
        <div id="visibilitySection">
            <label>Visibility:</label><br>
            <select id="artifactOption" style="width:100%; margin-bottom:10px;">
                <option value="VIEW">VIEW</option>
                <option value="NOVIEW">NOVIEW</option>
            </select><br>
        </div>

        <!-- ‚úÖ Text Info Section -->
        <div id="textInputSection">
            <label>Text Info:</label><br>
            <textarea id="artifactTextInfo" style="width:100%; height:80px;"></textarea>
        </div>

        <!-- ‚úÖ File Upload Section -->
        <div id="fileUploadSection" style="display:none;">
            <button onclick="openUploadModal()" style="margin-bottom:10px;">üìÅ Select/Upload File</button>
            <p id="uploadedFileLink" style="font-size:14px; color:gray;"></p>
        </div>

        <div style="text-align:right; margin-top:15px;">
            <button onclick="closeAddModal()">Cancel</button>
            <button onclick="saveArtifact()">Save</button>
        </div>
    </div>
</div>

<!-- ‚úèÔ∏è Modal to Edit Description -->
<div id="editDescriptionModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:#00000055; z-index:10000; justify-content:center; align-items:center;">
    <div style="background:white; padding:20px; border-radius:10px; max-width:400px; width:90%; box-shadow:0 0 10px rgba(0,0,0,0.2); position:relative;">
        <h4>üìù Edit Description</h4>
        <textarea id="newDescription" style="width:100%; height:80px; margin-bottom:10px;"></textarea>
        <div style="text-align:right;">
            <button onclick="closeDescriptionModal()">Cancel</button>
            <button onclick="saveDescription()">Save</button>
        </div>
    </div>
</div>

<!-- üì§ Upload Modal -->
<div id="uploadModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); z-index:10001; align-items:center; justify-content:center;">
    <div style="background:white; padding:30px; border-radius:12px; width:90%; max-width:400px; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.2);">
        <h3 style="margin-top:0;">üì§ Upload / Select File</h3>

        <input type="file" id="filePicker" style="margin:20px 0; width:100%;"><br>

        <div id="filePreview" style="margin:10px 0; font-size:14px; color:gray;">No file selected</div>

        <div style="margin-top:20px;">
            <button onclick="simulateUseFile()">Use Selected</button>
            <button onclick="closeUploadModal()">Cancel</button>
        </div>
    </div>
</div>


<div id="taglineWrapper" style="
    text-align: center;
    font-size: 20px;
    color: #ffffff; /* Default text color: White */
    background: #000; /* Black ribbon */
    position: fixed;
    top: 0;
    width: 100%;
    z-index: 1000;
    padding: 10px 0;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
">
    <a href="https://qrtagall.com" target="_blank" style="color: #FFA500; font-weight: bold; text-decoration: none;">
        QRTagAll
    </a>
    <span style="color: #ffffff;font-size: 15px">  Tag it. Own it. Share it.</span>
    <span id="versionTagx" style="color: #aaaaaa;font-size: 10px"> </span>

</div>





<script>

    const QRTagAll_Ver_ = "2.16";
    let editMode = false;
    let insertAfterRow = null;
    let selectedUploadedFileLink = "";
    let sheetID="";
    var currentEditMode = null; // new global
    var assetDataList = [];  // global
    let ownerEmail="";
    let selectedUploadedFileData = "";  // üî• NEW global to store base64
    let selectedUploadedFileName = "";   // üî• Add this new

    console.log("üöÄ Script block reached!");
    document.getElementById("versionTag").textContent = `Ver-${QRTagAll_Ver_}`;
    document.getElementById("versionTagx").textContent = `Ver-${QRTagAll_Ver_}`;




    async function sha256(input) {
        const encoder = new TextEncoder();
        const data = encoder.encode(input);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        return Array.from(new Uint8Array(hashBuffer))
            .map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
    }

    function claimQRCode() {
        alert("üöÄ Claim process initiated. This part will be linked to actual claiming logic.");
        // TODO: Redirect or initiate claim form
    }


    function cleanUpUrl() {
        const url = new URL(window.location.href);
        url.searchParams.delete("claimed");
        window.history.replaceState({}, document.title, url.toString());
    }

    const sessionEmail = localStorage.getItem("qr_claimed_email");
    //const sessionEmail = "dev.chandan2002x@gmail.com";//localStorage.getItem("qr_claimed_email");

    console.log("üìß QR was last claimed/verified by:", sessionEmail);
    if (sessionEmail)
    {
        document.getElementById("logoutBtn").style.display = "block";
    }


    /*********************LogOut *********************/
    function handleLogout() {
        localStorage.removeItem("qr_claimed_email");
        // Optional: clear sessionStorage too
        sessionStorage.removeItem("qr_claimed_email");

        alert("üîì You have been logged out.");
        window.location.reload();
    }

    /************** New Google Auth and QR Claim *********************/

    function googleLoginNew() {
        const id = getQueryParam("id");
        let assetName = document.getElementById("assetNameInput").value.trim();


        if (!assetName) {
            // alert("‚ö†Ô∏è Please enter an asset name before continuing.");
            // return;
            assetName = "Unnamed Asset";
        }

        const clientId = "121290253918-e3qk9a1qao4r4r89s52lcq79evcbbes2.apps.googleusercontent.com";
        const redirectUri = "https://process.qrtagall.com/oauth-claim-callback.html";
        const scope = "https://www.googleapis.com/auth/userinfo.email";

        // Encode both ID and assetName in a stringified JSON
        const stateObj = {
            id: id,
            asset: assetName
        };
        const state = encodeURIComponent(JSON.stringify(stateObj));

        const authUrl = `https://accounts.google.com/o/oauth2/v2/auth` +
            `?response_type=token` +
            `&client_id=${encodeURIComponent(clientId)}` +
            `&redirect_uri=${encodeURIComponent(redirectUri)}` +
            `&scope=${encodeURIComponent(scope)}` +
            `&state=${state}`;

        console.log("üîê Redirecting to Google OAuth:", authUrl);
        window.location.href = authUrl;
    }




    console.log("üîÑ Initiating Verification...");






    let isOwner=false;

    /*********************** ID Verification **************************/



    function loadProxyIframe() {
        return new Promise((resolve) => {
            proxyFrame = document.createElement("iframe");
            proxyFrame.style.display = "none";
            proxyFrame.src = "https://proxy.qrtagall.com";

            proxyFrame.onload = () => {
                console.log("‚úÖ Proxy iframe loaded");
                proxyLoaded = true;
                resolve();
            };

            document.body.appendChild(proxyFrame);
        });
    }



  async  function Verifyidx(idToVerify) {
        return new Promise((resolve, reject) => {
            if (!window.proxyFrame || !window.proxyLoaded) {
                reject("Proxy iframe not loaded");
                return;
            }

            const handler = (event) => {
                if (!event.data || (event.data.type !== "qr_verified" && event.data.type !== "qr_error")) return;

                window.removeEventListener("message", handler);

                if (event.data.type === "qr_verified") {
                    resolve(event.data.result);  // "VALID" or "INVALID"
                } else {
                    reject(event.data.error);
                }
            };

            window.addEventListener("message", handler);

            // Fire verification request to proxy
            proxyFrame.contentWindow.postMessage({
                type: "verify",
                id: idToVerify
            }, "*");
        });
    }


    async function verifyId() {
        const id = getQueryParam("id");

        const qrUrl = `https://process.qrtagall.com/?id=${id}`;
        QRCode.toCanvas(document.getElementById("qrCanvas"), qrUrl, { width: 160 }, function (error) {
            if (error) console.error("‚ùå QR code generation failed:", error);
        });

        const resultDiv = document.getElementById("result");
        const spinner = document.getElementById("spinner");
        const idText = document.getElementById("idText");
        const loginSection = document.getElementById("loginSection");

        if (!id) {
            spinner.style.display = "none";
            resultDiv.style.display = "block";
            resultDiv.textContent = "‚ùå No ID provided in URL.";
            resultDiv.style.color = "var(--error)";
            return;
        }

        idText.textContent = id;

        if (!id.includes("_")) {
            spinner.style.display = "none";
            resultDiv.style.display = "block";
            resultDiv.textContent = "‚ùå Invalid format. Expected format: TIMESTAMP_SIGNATURE";
            resultDiv.style.color = "var(--error)";
            return;
        }

        // ‚úÖ Check localStorage cache
        const cacheKey = `verified_${id}`;
        const cachedResult = localStorage.getItem(cacheKey);

        if (cachedResult === "VALID") {
            console.log("‚úÖ ID verified from cache:", id);
            spinner.style.display = "none";
            await fetchAssetData(id);
            return;
        }

        await loadProxyIframe();
        const result = await Verifyidx(id);

        if (result === "VALID") {
            localStorage.setItem(cacheKey, "VALID"); // ‚úÖ Save for future
            await fetchAssetData(id);
        } else {
            spinner.style.display = "none";
            resultDiv.style.display = "block";
            resultDiv.textContent = "‚ùå Invalid ID (Signature mismatch or tampered)";
            resultDiv.style.color = "var(--error)";
            loginSection.style.display = "none";
        }
    }




    function convertDriveUrl(value) {
        const match = value.match(/drive\.google\.com\/file\/d\/([^/]+)/);
        if (match) {
            const fileId = match[1];
            return `https://drive.google.com/uc?export=download&id=${fileId}`;
        }
        return value;
    }


    function getIconFromTitle(title = "") {
        const lower = title.toLowerCase();

        if (lower.includes("image") || lower.includes("photo") || lower.includes("pic")) return "üñºÔ∏è";
        if (lower.includes("video") || lower.includes("clip")) return "üé•";
        if (lower.includes("pdf") || lower.includes("manual") || lower.includes("doc")) return "üìÑ";
        if (lower.includes("invoice") || lower.includes("bill") || lower.includes("receipt")) return "üßæ";
        if (lower.includes("map") || lower.includes("location")) return "üó∫Ô∏è";
        if (lower.includes("drawing") || lower.includes("sketch")) return "üìê";
        if (lower.includes("audio") || lower.includes("mp3") || lower.includes("sound")) return "üéß";

        return "üîó"; // default
    }



    async function resolveAndRender(value, i, customTitle = `Link ${i}`) {
        value = convertDriveUrl(value);

        const isFileLikely = /\.(jpg|jpeg|png|gif|webp|mp4|webm|ogg|pdf)$/i.test(value);

        // üß† Pick emoji based on keywords in custom title
        const lower = customTitle.toLowerCase();
        const icon = getIconFromTitle(customTitle);

        try {
            let finalUrl = value;
            let contentType = "";

            if (isFileLikely) {
                const resolveUrl = `https://script.google.com/macros/s/AKfycbzgrQ9JzTzDY57cxlWs-g4kbiCb4C5j9X54BzE2eniGp3LQYKSFqNr5-yai4ZJmfjO83Q/exec?resolve=${encodeURIComponent(value)}`;
                const res = await fetch(resolveUrl);
                const json = await res.json();

                if (json.error) return `<p>‚ö†Ô∏è Couldn‚Äôt load ${customTitle}</p>`;

                finalUrl = json.resolvedUrl;
                contentType = json.contentType;
            }

            if (/image/i.test(contentType)) {
                return `<div><b>${icon} ${customTitle}</b><br><img src="${finalUrl}" style="max-width:100%;"></div>`;
            } else if (/video/i.test(contentType)) {
                return `<div><b>${icon} ${customTitle}</b><br><video controls width="100%"><source src="${finalUrl}"></video></div>`;
            } else if (/pdf/i.test(contentType)) {
                return `
                  <p><b>${icon} ${customTitle}</b></p>
                  <div style="margin-left:10px; margin-bottom: 10px;">
                    <a href="${finalUrl}" target="_blank" style="color:var(--primary); text-decoration:underline;">‚ÜóÔ∏è Visit</a>
                  </div>
                `;

            } else {
                const linkHost = finalUrl.match(/https?:\/\/([^/]+)/)?.[1] || "link";
                return `
        <div style="display:flex; align-items:center; border:1px solid #ddd; padding:12px; border-radius:8px; margin-bottom:10px;">
          <img src="https://www.google.com/s2/favicons?domain=${linkHost}&sz=64" alt="favicon" style="width:32px;height:32px;margin-right:10px;">
          <div style="flex-grow:1;">
            <div style="font-size:15px; font-weight:500; color:#333;">${icon} ${customTitle}</div>
            <a href="${finalUrl}" target="_blank" style="font-size:14px; color:var(--primary); text-decoration:none;">‚ÜóÔ∏è Visit</a>
          </div>
        </div>`;
            }

        } catch (e) {
            return `<p>‚ö†Ô∏è Error loading ${customTitle}</p>`;
        }
    }










    async function renderInfoBlock(data) {
        let html = "";
        const assets = data.assets || [];
        assetDataList = assets; // ‚úÖ Store globally for edit mode

        for (let i = 0; i < assets.length; i++) {
            const index = i; // ‚úÖ Fix async closure issue
            const item = assets[index];
            const title = item.title || `Asset ${index + 1}`;
            const type = (item.type || "").toUpperCase();
            const visibility = (item.visibility || "").toUpperCase();
            const url = item.url || "";

            const icon = getIconFromTitle(title);

            // üîí Visibility icon for owner view
            let visibilityIcon = "";
            if (isOwner) {
                if (visibility === "NOVIEW") {
                    visibilityIcon = `<span style="font-size: 14px; color: #888;" title="Hidden from public">üîí</span>`;
                } else if (visibility === "VIEW") {
                    visibilityIcon = `<span style="font-size: 14px; color: #4CAF50;" title="Visible to all">‚úÖ</span>`;
                }
            }

            html += `<div style="margin-bottom:20px; border:1px solid #ccc; padding:10px; border-radius:8px; background:#fafafa;">`;

            // üîç Main artifact info
            if (visibility === "NOVIEW" && !isOwner) {
                html += `<p><b>${index + 1}.</b> ${icon} <b>${title}</b> <span style="color:gray;">(üîí No view permission)</span></p>`;
            } else if (!url || url.trim() === "" || url.toLowerCase() === "not available") {
                html += `<p><b>${index + 1}.</b> ${icon} <b>${title}</b> <span style="color:gray;">(üîó Link not available)</span></p>`;
            } else if (type === "TEXT") {
                //html += `<p><b>${index + 1}.</b> ${icon} <b>${title}</b> ${visibilityIcon}: ${url}</p>`;

                    const urlRegex = /(https?:\/\/[^\s]+)/g;
                    const match = url.match(urlRegex);

                    if (match && match.length === 1 && match[0].trim() === url.trim()) {
                        // Pure URL only


                                            html += `
                      <p><b>${index + 1}.</b> ${icon} <b>${title}</b> ${visibilityIcon}</p>
                      <div style="margin-left: 10px; margin-bottom: 8px;">
                        <a href="${url}" target="_blank" style="color: var(--primary); text-decoration: underline;">üåê WebLink</a>
                      </div>
                    `;
                    } else if (match && match.length > 0) {
                        // Text with embedded URL(s)
                        const replaced = url.replace(urlRegex, (link) => {
                            return `<a href="${link}" target="_blank" style="color: var(--primary); text-decoration: underline;">üåê WebLink</a>`;
                        });

                                html += `
                          <p><b>${index + 1}.</b> ${icon} <b>${title}</b> ${visibilityIcon}</p>
                          <div style="margin-left: 10px; margin-bottom: 8px;">${replaced}</div>
                        `;
                        } else {
                        // Plain non-link text

                        let safeText = url.replace(/\n/g, "<br>");
                        safeText = boldLeadingLabels(safeText);

                        // Detect and enhance phone numbers like +91 8310355091 or +918310355091
                        const phoneMatch = url.match(/\+91[\s\-]*\d[\d\s\-]{9,}/g);

                        if (phoneMatch) {
                            phoneMatch.forEach((rawNum) => {
                                const cleanNum = rawNum.replace(/[^\d+]/g, '');  // removes spaces and dashes
                                const callBtn = `<a href="tel:${cleanNum}" style="background:#4CAF50;color:white;padding:4px 8px;border-radius:6px;font-size:12px;text-decoration:none;margin-left:6px;">üìû Call</a>`;
                                const waBtn = `<a href="https://wa.me/${cleanNum.replace('+', '')}" target="_blank" style="background:#25D366;color:white;padding:4px 8px;border-radius:6px;font-size:12px;text-decoration:none;margin-left:4px;">üí¨ WhatsApp</a>`;
                                safeText = safeText.replace(rawNum, `${rawNum}${callBtn}${waBtn}`);
                            });
                        }

                        html += `
                      <p><b>${index + 1}.</b> ${icon} <b>${title}</b> ${visibilityIcon}</p>
                      <div style="margin-left: 10px; margin-bottom: 10px; font-size: 14px; line-height: 1.6; background: #f9f9ff; padding: 10px 12px; border-left: 4px solid #005aab; border-radius: 6px;">
                        ${safeText}
                      </div>
                    `;

                    }
            } else if (type.includes("FILE") && /drive\.google\.com/.test(url)) {
                const match = url.match(/\/d\/([^/]+)/);
                const fileId = match ? match[1] : null;
                if (fileId) {
                    const iframePreview = `https://drive.google.com/file/d/${fileId}/preview`;
                    html += `
        <b>${index + 1}. ${icon} ${title} ${visibilityIcon}</b><br>
        <iframe src="${iframePreview}" width="100%" height="400" frameborder="0"
          allow="autoplay; encrypted-media"
          sandbox="allow-scripts allow-same-origin allow-presentation">
        </iframe>`;
                } else {
                    html += `<p><b>${index + 1}.</b> ${icon} <b>${title}</b> ${visibilityIcon}:
                        <a href="${url}" target="_blank">${url}</a></p>`;
                }
            } else if (url.startsWith("http")) {
                html += await resolveAndRender(url, index + 1, title); // still safe
            } else {
                html += `<p><b>${index + 1}.</b> ${icon} <b>${title}</b> ${visibilityIcon}: ${url}</p>`;
            }

            // ‚úèÔ∏è Edit / Delete / Add controls (only in edit mode)
            if (editMode) {
                html += `
      <div style="margin-top: 10px; display: flex; gap: 10px;">
        <button onclick="openAddModal(${index}, true)" style="font-size: 13px;">üìù Edit</button>
        <button onclick="deleteArtifact(${index})" style="font-size: 13px;">üóëÔ∏è Delete</button>
        <button onclick="openAddModal(${index})" style="font-size: 13px;">‚ûï Add Below</button>
      </div>
    `;
            }

            html += `</div>`;
        }


        return html || "<p style='color:gray;'>No asset information available.</p>";
    }


    function boldLeadingLabels(text) {
        return text.split('<br>').map(line => {
            const words = line.trim().split(/\s+/);
            const colonIndex = line.indexOf(':');

            if (colonIndex !== -1 && words.length > 0) {
                const prefix = line.slice(0, colonIndex);
                const prefixWordCount = prefix.trim().split(/\s+/).length;

                if (prefixWordCount <= 5) {
                    const rest = line.slice(colonIndex); // from ':' onward
                    return `<span style="color:#005aab; font-weight:bold; display:inline-block; margin-bottom:2px;">${prefix}</span>${rest}`;
                }
            }
            return `<span style="color:#333;">${line}</span>`;
        }).join('<br>');
    }







    /******************* Parsing info *******************/

    function getIconFromFileType(fileType = "") {
        switch (fileType.toUpperCase()) {
            case "IMAGEFILE": return "üñºÔ∏è";
            case "PDFFILE": return "üìÑ";
            case "TEXTFILE": return "üìù";
            case "AUDIOFILE": return "üéß";
            case "VIDEOFILE": return "üé•";
            default: return "üîó";
        }
    }

    function copyQRLink() {
        const id = getQueryParam("id");
        const qrUrl = `https://process.qrtagall.com/?id=${id}`;

        navigator.clipboard.writeText(qrUrl)
            .then(() => alert("üìã Link copied to clipboard!"))
            .catch(err => alert("‚ùå Failed to copy link."));
    }



    function maskEmailUser(email) {
        const atIndex = email.indexOf('@');
        if (atIndex === -1) return "";

        const username = email.slice(0, atIndex);

        if (username.length <= 4) {
            return username[0] + "*".repeat(username.length - 1);  // e.g., "a**"
        }

        const visibleCount = Math.ceil(username.length / 4); // show ~25% beginning and end
        const start = username.slice(0, visibleCount);
        const end = username.slice(-visibleCount);
        const masked = start + "*".repeat(username.length - 2 * visibleCount) + end;

        return masked;
    }




    async function fetchAssetData(id) {
        const popup = document.getElementById("popup");
        const mainContent = document.getElementById("mainContent");
        const assetTitle = document.getElementById("assetTitle");
        const assetLinks = document.getElementById("assetLinks");
        const resultDiv = document.getElementById("result");
        const spinner = document.getElementById("spinner");
        const loginSection = document.getElementById("loginSection");
        const editBtn = document.getElementById("editBtn");

        try {
            const apiUrl = `https://script.google.com/macros/s/AKfycbzgrQ9JzTzDY57cxlWs-g4kbiCb4C5j9X54BzE2eniGp3LQYKSFqNr5-yai4ZJmfjO83Q/exec?id=${encodeURIComponent(id)}`;
            const res = await fetch(apiUrl);
            const json = await res.json();
            spinner.style.display = "none";

            if (!json.found) {
                resultDiv.style.display = "block";
                resultDiv.style.color = "forestgreen";//"orangered";
                resultDiv.innerHTML = "This is a New and unclaimed ID !";
                loginSection.style.display = "block";
                return;
            }

            const data = json.data;

            popup.style.display = "none";
            mainContent.style.display = "block";


            /*** üî• Always remove old QR div first ***/
            const existingQRDiv = document.getElementById("qrWrapper");
            if (existingQRDiv) existingQRDiv.remove();


            /*** QR Code QR Block ***/
            const qrDiv = document.createElement("div");
            qrDiv.id = "qrWrapper";
            qrDiv.style.textAlign = "center";
            qrDiv.style.marginBottom = "20px";

            /*** 1. First prepare the URL to encode inside QR ***/
            const qrUrl = `https://process.qrtagall.com/?id=${encodeURIComponent(id)}`;

            /*** 2. Create Label (comes first visually) ***/
            const qrLabel = document.createElement("div");
            qrLabel.textContent = "üîó Scan this QR to access again";
            qrLabel.style.fontSize = "14px";
            qrLabel.style.color = "#666";
            qrLabel.style.marginBottom = "6px";

            /*** 3. Create QR Canvas ***/
            const qrCanvas = document.createElement("canvas");
            qrCanvas.id = "qrCanvas";
            qrCanvas.style.border = "1px solid #ccc";
            qrCanvas.style.padding = "6px";
            qrCanvas.style.borderRadius = "8px";
            qrCanvas.style.background = "#fff";
            qrCanvas.style.width = "200px";
            qrCanvas.style.height = "200px";

            /*** 4. Encode qrUrl inside Canvas ***/
            QRCode.toCanvas(qrCanvas, qrUrl, { width: 200 }, err => {
                if (err) console.error("QR generation error:", err);
            });

            const qrLink = document.createElement("a");
            qrLink.href = qrUrl;
            qrLink.target = "_blank";  // open in new tab
            qrLink.style.display = "inline-block";  // ensure QR remains block aligned
            qrLink.appendChild(qrCanvas);



            /*** 5. Actions (Download, Print, Copy, WhatsApp) ***/
            const qrActions = document.createElement("div");
            qrActions.style.marginTop = "8px";
            qrActions.innerHTML = `
  <button onclick="downloadQR()" title="Download QR" style="font-size:14px; margin-right:10px;">‚¨áÔ∏è</button>
  <button onclick="printQR()" title="Print QR" style="font-size:14px; margin-right:10px;">üñ®Ô∏è</button>
  <button onclick="copyQRLink()" title="Copy Link" style="font-size:14px; margin-right:10px;">üìã</button>
  <a href="https://wa.me/?text=${encodeURIComponent(`Check this Asset via QRTagAll:\n${qrUrl}`)}"
     target="_blank" title="Share on WhatsApp" style="font-size:14px; text-decoration:none;">üì±</a>
`;





            /*** 6. Append in Correct Order ***/
            qrDiv.appendChild(qrLabel);     // Label first
            //qrDiv.appendChild(qrCanvas);    // Then QR image
            qrDiv.appendChild(qrLink);
            qrDiv.appendChild(qrActions);   // Then buttons



            mainContent.insertBefore(qrDiv, assetTitle);


            /*** 4. AFTER fully building qrDiv, insert into page ***/
        const taglineWrapper = document.getElementById("taglineWrapper");
            if (taglineWrapper) {
                  taglineWrapper.parentNode.insertBefore(mainContent, taglineWrapper.nextSibling);
            }





            /*** Owner Detection ***/
            sheetID = (data.SheetID || "").trim();
            ownerEmail = (data.UserName || "").trim().toLowerCase();


            /*** Asset Title & Edit Option ***/
            /*** Asset Title & Edit Option ***/
            const maskedOwner = maskEmailUser(ownerEmail);

            assetTitle.innerHTML = `
          <div style="position: relative; display: flex; flex-direction: column; align-items: center; margin-bottom: 10px;">
            <div style="text-align: center;">
              ${data.Description || "Verified Asset"}<br>
            <div style="margin-top: 2px; line-height: 0.8;">
                <span style="font-size: 13px; color: gray;">(${id})</span><br>
                <span style="font-size: 12px; color: #888;">Owner: ${maskedOwner}</span>
              </div>
            </div>
            ${editMode ? `
              <button onclick="editDescription()"
                style="position: absolute; right: 10px; top: 10px; font-size: 13px;">
                ‚úèÔ∏è Edit
              </button>` : ""}
          </div>

          ${editMode ? `
            <div style="text-align: center; margin-top: 5px;">
              <button onclick="openAddModal(-1)" style="font-size: 13px;">‚ûï Add Artifact</button>
            </div>` : ""}
        `;


            const idx = getQueryParam("id");
            if (sessionEmail && (sessionEmail === ownerEmail )||  idx.startsWith("UNIVERSAL"))
            {
                isOwner = true;
                updatePanelBackground("#e6ffe6"); // ‚úÖ Green for ownerconst idx = getQueryParam("id");
                editBtn.innerHTML = "‚úèÔ∏è Edit Details";
            } else {
                isOwner = false;

                if (sessionEmail && sessionEmail !== ownerEmail) {
                    // ‚úÖ Someone owns it, but not you
                    updatePanelBackground("#ffb3b3"); // üî¥ Reddish
                    editBtn.innerHTML = "üîê Log-in as Owner<br>to Edit Details";
                } else {
                    // ‚úÖ No owner (unclaimed QR)
                    updatePanelBackground("#fffbe6"); // ‚ö†Ô∏è Yellow
                    editBtn.innerHTML = "üîê Log-in to Edit Details";
                }
            }


            /*** Artifact Rendering ***/
            const assetArray = data.assets || [];
            let html = "";


           /*

                const urlRegex = /(https?:\/\/[^\s]+)/g;


                if (!url || url === "Not Available") {
                    contentBlock = `<p style='color:gray;'>üîó Link not available</p>`;
                } else if (type === "TEXT") {

                    const match = url.match(urlRegex);
                    if (match) {
                        console.log("match>>>>",match);
                    }

                    if (match && match.length === 1 && match[0].trim() === url.trim()) {
                        // Pure URL only ‚Äî no other text
                        contentBlock = `<p><a href="${url}" target="_blank" style="color: var(--primary); text-decoration: underline;">üåê WebLink</a></p>`;
                    } else if (match && match.length > 0) {
                        console.log("Non PureURL>>>>",url);
                        // Text containing URL(s)

                        const replaced = url.replace(urlRegex, (link) => {
                            return `<a href="${link}" target="_blank" style="color: var(--primary); text-decoration: underline;">WebLink</a>`;
                        });

                        contentBlock = `<p><b>${icon} ${title}</b><br>${replaced}</p>`;
                    } else {
                        // Plain non-link text
                        contentBlock = `<p style='color:gray;'>${url}</p>`;
                    }
                    //contentBlock="";
                    console.log("URL URL>>>>",contentBlock);

                } else if (type === "IMAGEFILE") {
                    const drivePreview = url.includes("drive.google.com")
                        ? url.replace("/view?usp=sharing", "/preview")
                        : url;
                    contentBlock = `<img src="${drivePreview}" style="max-width:100%; margin-top:5px;">`;
                } else if (type === "PDFFILE" || type === "TEXTFILE") {
                    contentBlock = `<iframe src="${url}" width="100%" height="400" style="border:0;"></iframe>`;
                } else if (type === "AUDIOFILE") {
                    contentBlock = `<audio controls src="${url}" style="width:100%;"></audio>`;
                } else if (type === "VIDEOFILE") {
                    contentBlock = `<video controls width="100%"><source src="${url}"></video>`;
                } else {
                    contentBlock = `<a href="${url}" target="_blank">üîó Open Link</a>`;
                }



                html += `<div style="margin-bottom:20px; border:1px solid #ccc; padding:10px; border-radius:8px; background:#fafafa;">
        <b>${icon} ${title}</b><br>${contentBlock}`;

                if (editMode) {
                    html += `
          <div style="margin-top: 10px; display: flex; gap: 10px;">
            <button onclick="deleteArtifact(${index})">üóëÔ∏è Delete</button>
            <button onclick="openAddModal(${index})">‚ûï Add Below</button>
          </div>`;
                }

                html += `</div>`;
            });
            */

            assetLinks.innerHTML = await renderInfoBlock(data);
            //assetLinks.innerHTML = html || "<p style='color:gray;'>No asset information available.</p>";

            editBtn.disabled = false;
            editBtn.classList.remove("disabled-button");
            editBtn.classList.add("enabled");

        } catch (err) {
            spinner.style.display = "none";
            resultDiv.style.display = "block";
            resultDiv.innerHTML = "‚ùå Error retrieving data. " + err;
            console.error("‚ùå Error retrieving data:", err);
        }
        finally
        {

            document.getElementById("fullScreenSpinner").style.display = "none";

        }

        //spinnerOverlay.style.display = "none";
    }


    //assetLinks.innerHTML = await renderInfoBlock(data);


    /***************************************************************/



    function updatePanelBackground(colorCode) {
        const panel = document.getElementById("mainContent");
        if (panel) {
            panel.style.backgroundColor = colorCode;
            //console.log("üé® Panel background updated to:", colorCode);
        }
    }


    function showOwnerConfirmModal() {
        const modal = document.getElementById("ownerConfirmModal");
        const heading = modal.querySelector("h3");
        const subtext = modal.querySelector("p");

        //const sessionEmail = localStorage.getItem("qr_claimed_email");

        if (sessionEmail) {
            heading.innerHTML = `‚ö†Ô∏è This QR is owned by a different user.`;
            subtext.innerHTML = `You are logged in as <b>${sessionEmail}</b>.<br>Would you like to switch User Account?`;
        } else {
            heading.innerHTML = `‚ö†Ô∏è Only QR owner can edit!`;
            subtext.innerHTML = `Are you the owner ‚Äì would you like to log in?`;
        }

        modal.style.display = "flex";
        /*
          document.getElementById("ownerLoginYes").onclick = () =>
        {
             modal.style.display = "none";
            if(sessionEmail && !isOwner)
            {
                handleLogout();
            }
            else
            {
             googleLoginForEdit();  // üëà Trigger alternate login flow
            }


          };*/

        document.getElementById("ownerLoginCancel").onclick = () => {
            modal.style.display = "none";
        };


        document.getElementById("ownerLoginYes").onclick = () => {
            modal.style.display = "none";

            const id = getQueryParam("id");

            if (sessionEmail) {
                // ‚ö†Ô∏è Logout flow for switching account
                //const redirectAfterLogout = `https://process.qrtagall.com/force-relogin.html?id=${encodeURIComponent(id)}`;
                //window.location.href = `https://accounts.google.com/Logout?continue=https://process.qrtagall.com/force-relogin.html?id=${encodeURIComponent(id)}`;
                // Clear stored session
                localStorage.removeItem("qr_claimed_email");
                sessionStorage.removeItem("qr_claimed_email");

                // Re-initiate login (skip logout URL)
                googleLoginForEdit(id);

            } else {
                // ‚úÖ Direct login for first time
                googleLoginForEdit(id);
            }
        };



    }







    function googleLoginForEdit(id) {
        const clientId = "121290253918-e3qk9a1qao4r4r89s52lcq79evcbbes2.apps.googleusercontent.com";
        const redirectUri = "https://process.qrtagall.com/oauth-callback.html";
        const scope = "https://www.googleapis.com/auth/userinfo.email";

        const authUrl = `https://accounts.google.com/o/oauth2/v2/auth` +
            `?response_type=token` +
            `&client_id=${encodeURIComponent(clientId)}` +
            `&redirect_uri=${encodeURIComponent(redirectUri)}` +
            `&scope=${encodeURIComponent(scope)}` +
            `&state=${encodeURIComponent(id)}`;


        window.location.href = authUrl;
    }

    /***************************************** EDIT *************************/



    function editAlert() {
        const editBtn = document.getElementById("editBtn");

        if (editBtn.disabled) {
            alert("üîê Please log in first to edit this asset.");
        } else {
            if (!isOwner) {
                showOwnerConfirmModal();
            } else {

                document.getElementById("fullScreenSpinner").style.display = "flex";



                editMode = true;
                fetchAssetData(getQueryParam("id"));  // Reload in edit mode
            }
        }
    }

    /*
    function openAddModal(afterRowNum) {
      insertAfterRow = afterRowNum;
      selectedUploadedFileLink = "";

      document.getElementById("artifactBasicInfo").value = `New Artifact ${afterRowNum + 1}`;
      document.getElementById("artifactTextInfo").value = "Enter your text here...";
      document.getElementById("artifactFileType").value = "TEXT";
      document.getElementById("artifactOption").value = "VIEW";
      document.getElementById("uploadedFileLink").textContent = "";
      onFileTypeChange();

      document.getElementById("addArtifactModal").style.display = "flex";
    }


    function closeAddModal() {
      document.getElementById("addArtifactModal").style.display = "none";
      insertAfterRow = null;
      selectedUploadedFileLink = "";
    }

    function saveArtifact() {
      const info = document.getElementById("artifactBasicInfo").value.trim();
      const fileType = document.getElementById("artifactFileType").value;
      const visibility = document.getElementById("artifactOption").value;
      const isText = fileType === "TEXT";
      const url = isText
        ? document.getElementById("artifactTextInfo").value.trim()
        : selectedUploadedFileLink;

      if (!info || !fileType || !visibility || (!isText && !url)) {
        alert("‚ö†Ô∏è Please complete all fields.");
        return;
      }

      const payload = {
        afterRow: insertAfterRow,
        basicInfo: info,
        fileType,
        options: visibility,
        localUrl: url
      };

      alert(`‚ûï New artifact to be inserted after row ${insertAfterRow}:\n\n${JSON.stringify(payload, null, 2)}`);
      // TODO: insertArtifactInSheet(payload);

      closeAddModal();
    }
    */

    function deleteArtifact(rowNum) {
        const confirmed = confirm(`Are you sure you want to delete artifact at row ${rowNum}?`);
        if (confirmed) {
            saveArtifactInfo({
                startCell: rowNum + 6,  // üß† Asset index to sheet row mapping (because 6th row starts artifacts)
                basicInfo: "",
                fileType: "",
                visibility: "",
                linkOrText: "",
                rawfiledata: "",
                rawfilename: selectedUploadedFileName,
                isDelete: true
            });
        }
    }



    function openAddModal(afterRowNum, isEditMode = false) {
        selectedUploadedFileLink = "";

        const basicInfoInput = document.getElementById("artifactBasicInfo");
        const textInfoInput = document.getElementById("artifactTextInfo");
        const fileTypeInput = document.getElementById("artifactFileType");
        const visibilityInput = document.getElementById("artifactOption");
        const uploadedFileLink = document.getElementById("uploadedFileLink");
        const modalTitle = document.getElementById("addArtifactModalTitle");

        // ‚úÖ Here: set global insertAfterRow properly
        if (afterRowNum === -1) {

            insertAfterRow --; //=-2;
            modalTitle.innerText = "‚ûï Add Artifact at Top";
        } else {
            insertAfterRow = afterRowNum;
            modalTitle.innerText = "‚ûï Add Artifact Info";
        }


        if (isEditMode) {


            currentEditMode = "edit";

            const item = assetDataList[afterRowNum];
            const fileType = (item.type || "TEXT").toUpperCase();

            modalTitle.innerText = `üìù Edit ${fileType === "TEXT" ? "Text Info" : "Artifact Visibility"}`;

            basicInfoInput.value = item.title || "";
            fileTypeInput.value = fileType;
            visibilityInput.value = (item.visibility || "VIEW").toUpperCase();

            if (fileType === "TEXT") {
                // Make all fields editable
                textInfoInput.value = item.url || "";
                uploadedFileLink.textContent = "";

                basicInfoInput.disabled = false;
                fileTypeInput.disabled = false;
                textInfoInput.disabled = false;
                visibilityInput.disabled = false;

                document.getElementById("artifactFileType").parentElement.style.display = "block";
                document.getElementById("textInputSection").style.display = "block";
                document.getElementById("fileUploadSection").style.display = "none";
            } else {


                textInfoInput.value = "";
                uploadedFileLink.textContent = item.url || "";

                basicInfoInput.disabled = false;
                fileTypeInput.disabled = true;
                textInfoInput.disabled = true;
                visibilityInput.disabled = false;

                document.getElementById("artifactFileType").parentElement.style.display = "block";
                document.getElementById("textInputSection").style.display = "none";
                document.getElementById("fileUploadSection").style.display = "block";

                // üîí Disable upload for editing existing files
                const uploadBtn = document.querySelector("#fileUploadSection button");
                if (uploadBtn) {
                    uploadBtn.disabled = true;
                    uploadBtn.style.opacity = "0.6";
                    uploadBtn.style.cursor = "not-allowed";
                }

            }
        } else {
            currentEditMode = "add";

            basicInfoInput.disabled = false;
            fileTypeInput.disabled = false;
            textInfoInput.disabled = false;

            document.getElementById("artifactFileType").parentElement.style.display = "block";
            document.getElementById("textInputSection").style.display = "block";
            document.getElementById("fileUploadSection").style.display = "none";

            basicInfoInput.value = insertAfterRow === -2 ? "New Artifact" : `New Artifact ${insertAfterRow + 2}`;



            //basicInfoInput.value = insertAfterRow === -2 ? "New Artifact" : `New Artifact ${insertAfterRow + 2}`;
            textInfoInput.value = "Enter your text here...";
            fileTypeInput.value = "TEXT";
            visibilityInput.value = "VIEW";
            uploadedFileLink.textContent = "";
        }

        document.getElementById("addArtifactModal").style.display = "flex";
    }






    function closeAddModal() {

        console.log(">>>Closing Modal");

        document.getElementById("fullScreenSpinner").style.display = "none";

        document.getElementById("addArtifactModal").style.display = "none";
        insertAfterRow = null;
        selectedUploadedFileLink = "";
        currentEditMode = null;


    }


    //CM edit
    function saveArtifact() {
        const basicInfo = document.getElementById("artifactBasicInfo").value.trim();
        const fileType = document.getElementById("artifactFileType").value;
        const visibility = document.getElementById("artifactOption").value;
        const isText = fileType === "TEXT";
        const url = isText
            ? document.getElementById("artifactTextInfo").value.trim()
            : selectedUploadedFileLink || document.getElementById("uploadedFileLink").textContent.trim();

        if (!basicInfo || !fileType || !visibility || (!isText && !url)) {
            alert("‚ö†Ô∏è Please complete all fields.");
            return;
        }

        if (currentEditMode === "edit") {

            const fileTypeNow = document.getElementById("artifactFileType").value.toUpperCase();

            /*
            // ‚úÖ Edit mode: Only update visibility
            const payload = {
                rowNum: insertAfterRow,  // In Edit, we know the row directly
                visibility: visibility
            };

            alert(`üìù Update artifact:\nVisibility set to ‚û°Ô∏è ${payload.visibility}`);

            saveArtifactInfo({
                startCell: "C" + (payload.rowNum + 6), // mapping asset array index to Sheet row number (Row 6 onward)
                visibility: payload.visibility,
                modalId: "addArtifactModal"   // ‚úÖ Auto-close Add Modal after save
            });
            // TODO: Call backend to only update visibility

             */

            if (fileTypeNow === "TEXT") {
                // üîÑ Save full update for TEXT
                saveArtifactInfo({
                    startCell: insertAfterRow + 6,
                    basicInfo: basicInfo,
                    fileType: fileType,
                    visibility: visibility,
                    linkOrText: url,
                    modalId: "addArtifactModal",
                    rawfilename: selectedUploadedFileName,
                    rawfiledata: selectedUploadedFileData
                });
            } else {
                // üîí For other types, update visibility only
                // ‚úÖ For xxxFILE: Save Basic Info + Visibility
                /*
                saveArtifactInfo({
                    startCell: insertAfterRow + 6,
                    basicInfo: basicInfo,
                    visibility: visibility,
                    modalId: "addArtifactModal"
                });*/
            }

            const original = assetDataList[insertAfterRow];

            saveArtifactInfo({
                startCell: insertAfterRow + 6,
                basicInfo: basicInfo,
                fileType: original.type || "",         // ‚úÖ keep original fileType
                visibility: visibility,
                linkOrText: original.url || "",        // ‚úÖ preserve original file link
                modalId: "addArtifactModal"
            });


        }
        else {
            // ‚úÖ Add mode: Insert full artifact
            const payload = {
                afterRow: insertAfterRow,
                basicInfo,
                fileType,
                options: visibility,
                localUrl: url
            };

           // alert(`‚ûï New artifact to be inserted after row ${insertAfterRow}:\n\n${JSON.stringify(payload, null, 2)}`);

            saveArtifactInfo({
                startCell: payload.afterRow + 7,  // üß† afterRow is artifact index; +6 (starting row) +1 (insert *below*)
                basicInfo: payload.basicInfo,
                fileType: payload.fileType,
                visibility: payload.options,
                linkOrText: payload.localUrl,
                isInsert: true,
                modalId: "addArtifactModal",
                rawfilename: selectedUploadedFileName,
                rawfiledata: selectedUploadedFileData
            });
        }


        closeAddModal();
    }




    /************************ Edit Description *************/
    function editDescription() {
        //alert("üìù Modal to edit Description will be added here.");
        const current = document.getElementById("assetTitle").innerText.split("\n")[0];
        document.getElementById("newDescription").value = current;
        document.getElementById("editDescriptionModal").style.display = "flex";
    }

    function closeDescriptionModal() {
        console.log(">>>Closing Description Modal");
        document.getElementById("fullScreenSpinner").style.display = "none";
        document.getElementById("editDescriptionModal").style.display = "none";
    }






    /*
    async function saveArtifactWithOAuth() {
      const accessToken = localStorage.getItem("qr_access_token");
      if (!accessToken) {
        alert("üîí Please login first.");
        return;
      }

      const id = getQueryParam("id");
      const sheetId = "1K3P8CSrLUmVRzEq6hAKUaWcBrsAdon1AdOguwLMPD4Y";
      const startCell = "C14";

      const basic = "TestImage";
      const fileType = "IMAGEFILE";
      const option = "VIEW";
      const url = "https://drive.google.com/file/d/123abc/view?usp=sharing";

      const values = `${basic}||${fileType}||${option}||${url}`;

      const query = new URLSearchParams({
        mode: "updateCells",
        id,
        sheetId,
        range: startCell,
        values
      });

      const targetUrl = `https://script.google.com/macros/s/YOUR_SCRIPT_C_ID/exec?${query.toString()}`;

      try {
        const response = await fetch(targetUrl, {
          headers: {
            Authorization: `Bearer ${accessToken}`
          }
        });

        const data = await response.json();

        if (data.success) {
          alert("‚úÖ OAuth-authenticated write successful!");
        } else {
          alert("‚ùå Write failed: " + data.message);
        }
      } catch (err) {
        console.error("OAuth Fetch Error:", err);
        alert("‚ùå Network/Auth Error");
      }
    }
    */





    function saveDescription() {
        const updatedDesc = document.getElementById("newDescription").value.trim();

        saveArtifactInfo({
            startCell: "B2",
            basicInfo: updatedDesc,
            fileType: "",
            visibility: "",
            linkOrText: "",
            modalId: "editDescriptionModal",
            rawfilename: selectedUploadedFileName,
            rawfiledata: selectedUploadedFileData
        });



    }





    /*
    async function saveArtifactInfo({
                                        startCell,
                                        basicInfo = undefined,
                                        fileType = undefined,
                                        visibility = undefined,
                                        linkOrText = undefined,
                                        modalId = null,
                                        isInsert = false,
                                        isDelete = false,
                                        rawfiledata = undefined
                                    }) {
        const id = getQueryParam("id");
        const sheetId = sheetID;
        const secretKey = "optional_static_key";

        // ‚úÖ Always prepare 4 fields
        const valueParts = [
            basicInfo !== undefined ? basicInfo : "",
            fileType !== undefined ? fileType : "",
            visibility !== undefined ? visibility : "",
            linkOrText !== undefined ? linkOrText : ""
        ];

        // ‚úÖ If somehow more values are passed, trim extra
        const finalValues = valueParts.slice(0, 4).join("||");

        const query = new URLSearchParams({
            mode: "updateCells",
            id,
            sheetId,
            range: startCell,
            values: finalValues,
            secret_key: secretKey
        });

        if (isInsert) query.append("insert", "1");
        if (isDelete) query.append("delete", "1");
        if (rawfiledata) query.append("rawfiledata", encodeURIComponent(rawfiledata));


        //const targetUrl = `https://script.google.com/macros/s/AKfycbwLq3TCe-Zd0BI64Im9sGkIGH2kYvvGpWPTdM0-hVrGfP9UPx1j1GOC3YJVOGceycJn/exec?${query.toString()}`;
        //console.log("‚úÖ Final Target URL:", targetUrl);
        //triggerLink_old(targetUrl, modalId);



        const params = `${query.toString()}`;

        console.log(">>>>>>>>> URL........", params);

        if (rawfiledata)
        {

        }
        else
        await triggerLink_old(params, modalId);
    }
    */

    async function saveArtifactInfo({
                                        startCell,
                                        basicInfo = undefined,
                                        fileType = undefined,
                                        visibility = undefined,
                                        linkOrText = undefined,
                                        modalId = null,
                                        isInsert = false,
                                        isDelete = false,
                                        rawfilename = undefined,
                                        rawfiledata = undefined
                                    }) {

        const id = getQueryParam("id");
        const sheetId = sheetID;
        const secretKey = "optional_static_key";

        /*
        const valueParts = [
            basicInfo !== undefined ? basicInfo : "",
            fileType !== undefined ? fileType : "",
            visibility !== undefined ? visibility : "",
            linkOrText !== undefined ? linkOrText : ""
        ];

        const finalValues = valueParts.slice(0, 4).join("||");

         */

        // ‚úÖ Build values dynamically
        const safe = (v) => typeof v === "string" ? v.trim() : v;
        const valueParts = [];

        if (basicInfo !== undefined) valueParts.push(safe(basicInfo));
        if (fileType !== undefined) valueParts.push(safe(fileType));
        if (visibility !== undefined) valueParts.push(safe(visibility));
        if (linkOrText !== undefined) valueParts.push(safe(linkOrText));

        const finalValues = valueParts.join("||");

        const query = new URLSearchParams({
            mode: "updateCells",
            id,
            sheetId,
            range: startCell,
            values: finalValues,
            secret_key: secretKey
        });

        if (isInsert) query.append("insert", "1");
        if (isDelete) query.append("delete", "1");

        const params = query.toString();

        console.log(">>>>>>>>> URL........", params);

        if (rawfiledata) {
            await triggerLink_post(params, rawfiledata, rawfilename, modalId);
        } else {
            await triggerLink_old(params, modalId);
        }
    }

    //CCCMEDIT




    async function triggerLink_post(params, rawfiledata,rawfilename, modalId = null) {
        const targetUrl = `https://script.google.com/macros/s/AKfycbwLq3TCe-Zd0BI64Im9sGkIGH2kYvvGpWPTdM0-hVrGfP9UPx1j1GOC3YJVOGceycJn/exec`;

        if (modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = "none";
        }

        const spinner = document.getElementById("fullScreenSpinner");
        // if (spinner) spinner.style.display = "flex";

        // üî• Step 1: OAuth Force Login
        async function fetchUserEmail(token) {
            try {
                const res = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                    headers: {
                        Authorization: `Bearer ${token}`
                    }
                });
                const data = await res.json();
                return (data.email || "").toLowerCase();
            } catch (e) {
                console.error("‚ùå Failed to fetch user email:", e);
                return "";
            }
        }

        await new Promise((resolve, reject) => {
            const client = google.accounts.oauth2.initTokenClient({
                client_id: '121290253918-cae49r46mo3r9f9rhd7rq6ao9ae69jjv.apps.googleusercontent.com',
                scope: 'https://www.googleapis.com/auth/userinfo.email',
                prompt: 'consent',
                callback: async (response) => {
                    if (response.access_token) {
                        console.log("‚úÖ Access token acquired.");
                        localStorage.setItem('qr_oauth_token', response.access_token);

                        const userEmail = await fetchUserEmail(response.access_token);
                        console.log("üìß Logged in as:", userEmail);

                        const idx = getQueryParam("id");
                        if (userEmail === ownerEmail || idx.startsWith("UNIVERSAL"))
                        {
                            console.log("‚úÖ Owner verified, proceeding...");
                            resolve();
                        } else {
                            spinner.style.display = "none";
                            alert("‚ùå You are not the owner of this QR Asset.\nPlease login with the correct account.");
                            reject("User is not the owner");
                        }
                    } else {
                        spinner.style.display = "none";
                        reject("‚ùå OAuth login failed.");
                    }
                },
            });

            client.requestAccessToken();
        });

        if (spinner) spinner.style.display = "flex";
        await new Promise(resolve => setTimeout(resolve, 50));  // allow browser to paint spinner

        // üî• Step 2: After Auth Verified, do Form+Iframe POST
        const finalData = {
            ...Object.fromEntries(new URLSearchParams(params)),
            rawfiledata: rawfiledata,
            rawfilename: rawfilename || ""
        };

        await new Promise((resolve, reject) => {
            const iframe = document.createElement("iframe");
            iframe.name = "hidden_iframe_" + Math.random().toString(36).substring(2);
            iframe.style.display = "none";
            document.body.appendChild(iframe);

            const form = document.createElement("form");
            form.method = "POST";
            form.action = targetUrl;
            form.target = iframe.name;

            const input = document.createElement("input");
            input.type = "hidden";
            input.name = "data";
            input.value = JSON.stringify(finalData);

            form.appendChild(input);
            document.body.appendChild(form);

            iframe.onload = function() {
                spinner.style.display = "none";
                alert("‚úÖ Artifact info saved successfully .");
                location.reload();
                resolve();
            };

            form.submit();
        });
    }




    async function triggerLink_old(params, modalId = null) {


        const targetUrl = `https://script.google.com/macros/s/AKfycbwLq3TCe-Zd0BI64Im9sGkIGH2kYvvGpWPTdM0-hVrGfP9UPx1j1GOC3YJVOGceycJn/exec?${params}`;
        //const ownerEmail = (sessionEmail || "").toLowerCase(); // üî• assuming sessionEmail is already known
        // console.log(">>>>>>>>> URL........", targetUrl);

        if (modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = "none";
        }

        const spinner = document.getElementById("fullScreenSpinner");


        // Helper to fetch user's email from token
        async function fetchUserEmail(token) {
            try {
                const res = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                    headers: {
                        Authorization: `Bearer ${token}`
                    }
                });
                const data = await res.json();
                return (data.email || "").toLowerCase();
            } catch (e) {
                console.error("‚ùå Failed to fetch user email:", e);
                return "";
            }
        }

        await new Promise((resolve, reject) => {
            const client = google.accounts.oauth2.initTokenClient({
                client_id: '121290253918-cae49r46mo3r9f9rhd7rq6ao9ae69jjv.apps.googleusercontent.com',
                scope: 'https://www.googleapis.com/auth/userinfo.email',
                prompt: 'consent',
                callback: async (response) => {
                    if (response.access_token) {
                        console.log("‚úÖ Access token acquired.");
                        localStorage.setItem('qr_oauth_token', response.access_token);

                        const userEmail = await fetchUserEmail(response.access_token);
                        console.log("üìß Logged in as:", userEmail);

                        //if (userEmail === ownerEmail)
                        if (userEmail === ownerEmail || idx.startsWith("UNIVERSAL"))
                        {
                            console.log("‚úÖ Owner verified, proceeding...");
                            resolve();
                        } else {
                            spinner.style.display = "none";
                            alert("‚ùå You are not the owner of this QR Asset.\nPlease login with the correct account.");
                            reject("User is not the owner");
                        }
                    } else {
                        spinner.style.display = "none";
                        reject("‚ùå OAuth login failed.");
                    }
                },
            });

            client.requestAccessToken();
        });

        if (spinner) spinner.style.display = "flex";
        await new Promise(resolve => setTimeout(resolve, 50));  // allow browser to paint spinner

        // üî• After owner check passed, now fire image load
        try {
            const img = new Image();
            img.style.display = "none";
            img.src = targetUrl;
            document.body.appendChild(img);

            setTimeout(() => {
                if (img && img.parentNode) {
                    img.parentNode.removeChild(img);
                }
                spinner.style.display = "none";
            }, 5000);

        } catch (e) {
            console.error("‚ùå Image load error:", e);
        }

        setTimeout(() => {
            spinner.style.display = "none";
            alert("‚úÖ Artifact info saved.");
            location.reload();
        }, 3000);
    }






    async function triggerLink_old1(params, modalId = null) {
        const targetUrl = `https://script.google.com/macros/s/AKfycbwLq3TCe-Zd0BI64Im9sGkIGH2kYvvGpWPTdM0-hVrGfP9UPx1j1GOC3YJVOGceycJn/exec?${params}`;




        if (modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = "none";
        }
        document.getElementById("fullScreenSpinner").style.display = "flex";

        // Let the browser paint the spinner FIRST
        setTimeout(async () => {



            try {
                const img = new Image();
                img.src = targetUrl;
            } catch (e) {

            }

            // let response = null;
            // try {
            //     const res = await fetch(targetUrl);
            //     response = await res.json();
            // } catch (e) {
            // }

            //console.log(">>>>>>>>> Response.........", response);




            setTimeout(() => {


                document.getElementById("fullScreenSpinner").style.display = "none";

                // alert("‚úÖ Artifact info saved.");
                location.reload();
            }, 3000);

        },1000); // üî• Magic! spinner visible before image src fires
    }


    /*
  async function triggerLink_old(params, modalId = null) {
  const targetUrl = `https://script.google.com/macros/s/AKfycbwLq3TCe-Zd0BI64Im9sGkIGH2kYvvGpWPTdM0-hVrGfP9UPx1j1GOC3YJVOGceycJn/exec?${params}`;
  let accessToken = localStorage.getItem('qr_oauth_token');

  if (modalId) {
      const modal = document.getElementById(modalId);
      if (modal) modal.style.display = "none";
  }

  const spinner = document.getElementById("fullScreenSpinner");
  if (spinner) spinner.style.display = "flex";

  async function requestLogin() {
      await new Promise((resolve, reject) => {
          const client = google.accounts.oauth2.initTokenClient({
              client_id: '121290253918-cae49r46mo3r9f9rhd7rq6ao9ae69jjv.apps.googleusercontent.com',
              scope: 'https://www.googleapis.com/auth/userinfo.email',
              prompt: 'consent',
              callback: (response) => {
                  if (response.access_token) {
                      console.log("‚úÖ Access token acquired after login.");
                      localStorage.setItem('qr_oauth_token', response.access_token);
                      accessToken = response.access_token;
                      resolve();
                  } else {
                      reject("‚ùå OAuth login failed.");
                  }
              },
          });
          client.requestAccessToken();
      });
  }

  if (!accessToken) {
      console.log("üîí No token found. Forcing login...");
      await requestLogin();
  } else {
      console.log("üîì Using existing saved access token.");
  }

  // Now fire the URL silently using Image
  try {
      const img = new Image();
      img.style.display = "none"; // invisible
      img.src = targetUrl;
      document.body.appendChild(img);

      // optional: clean up after 5 sec
      setTimeout(() => {
          if (img && img.parentNode) {
              img.parentNode.removeChild(img);
          }
      }, 5000);
  } catch (e) {
      console.error("‚ùå Image fetch failed:", e);
  }

  setTimeout(() => {
      spinner.style.display = "none";
      //alert("‚úÖ Artifact info has been tried to save.");
      location.reload();
  }, 3000);
}

*/


    /*********************************************************************/
    /**************************** Modal: Add ****************************/

    function onFileTypeChange() {
        const type = document.getElementById("artifactFileType").value;
        if (type === "TEXT") {
            document.getElementById("textInputSection").style.display = "block";
            document.getElementById("fileUploadSection").style.display = "none";
        } else {
            document.getElementById("textInputSection").style.display = "none";
            //document.getElementById("fileUploadSection").style.display = "block";
            document.querySelector("#fileUploadSection button").disabled = true;
            document.querySelector("#fileUploadSection button").style.opacity = "0.6";
            document.querySelector("#fileUploadSection button").style.cursor = "not-allowed";
        }
    }

    function openUploadModal() {
        document.getElementById("uploadModal").style.display = "flex";
        document.getElementById("filePicker").value = "";
        document.getElementById("filePreview").textContent = "";
    }

    function closeUploadModal() {
        document.getElementById("uploadModal").style.display = "none";
    }

    function simulateUseFile() {
        const fileInput = document.getElementById("filePicker");
        const file = fileInput.files[0];

        if (!file) {
            alert("‚ùå No file selected.");
            closeUploadModal();
            return;
        }

        if (file.size > 10 * 1024 * 1024) {  // 10 MB
            alert("‚ö†Ô∏è File size exceeds 10MB. Please select a smaller file.");
            closeUploadModal();
            return;
        }

        const reader = new FileReader();
        reader.onload = function(event) {
            selectedUploadedFileData = event.target.result.split(',')[1]; // get base64
            selectedUploadedFileName = file.name;  // üî• capture filename
            document.getElementById("uploadedFileLink").textContent = `üÜó Selected file: ${file.name}`;
            closeUploadModal();
        };
        reader.readAsDataURL(file);
    }






    function saveNewArtifact() {
        const basic = document.getElementById("newBasicInfo").value.trim();
        const filetype = document.getElementById("newFileType").value.trim().toUpperCase();
        const option = document.getElementById("newOptions").value.trim().toUpperCase();
        const link = document.getElementById("newLocalLink").value.trim();

        if (!basic || !filetype || !option) {
            alert("‚ö†Ô∏è Please fill all required fields.");
            return;
        }

        alert(`‚úÖ New artifact to be inserted after row ${insertAfterRow}:\n\nTitle: ${basic}\nType: ${filetype}\nOption: ${option}\nLink: ${link}`);

        // üß† Here you can later call Apps Script API to insert into sheet.

        closeAddModal();
    }



    verifyId();
    //handleClaimedReturn();
</script>


</body>
</html>
