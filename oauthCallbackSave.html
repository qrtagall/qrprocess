<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üîÑ Saving Artifact...</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f4f4;
      text-align: center;
      padding-top: 80px;
      color: #333;
    }
    .spinner {
      margin-top: 20px;
      font-size: 22px;
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0% { opacity: 0.2; }
      50% { opacity: 1; }
      100% { opacity: 0.2; }
    }
    .info {
      font-size: 14px;
      color: #777;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>üîê Saving Artifact (v-3)</h2>
  <p class="info" id="status">Just a moment while we save your artifact...</p>
  <div class="spinner">‚è≥</div>

<script>
(async function() {
  try {
    const params = new URLSearchParams(window.location.hash.substring(1));
    const accessToken = params.get("access_token");
    const rawState = params.get("state") || "";
    const saveUrl = decodeURIComponent(rawState);

    const statusEl = document.getElementById("status");

    if (!saveUrl) {
      statusEl.textContent = "‚ùå Missing save URL.";
      return;
    }

    console.log("‚úÖ Save URL received:", saveUrl);

    // ‚úÖ Redirect to saveUrl to save artifact
    //window.location.href = saveUrl;
/*
const iframe = document.createElement('iframe');
iframe.src = saveUrl;
iframe.style.display = "none"; 
document.body.appendChild(iframe);
*/
    window.location.href = saveUrl;
    

    // ‚úÖ After some delay, trigger second OAuth escape
    setTimeout(() => {
       console.log("Timeout Triggered");
      try {
        // Extract ID from saveUrl manually
        const idMatch = saveUrl.match(/[?&]id=([^&]+)/);
        const id = idMatch ? idMatch[1] : null;

        if (!id) {
          console.warn("‚ö†Ô∏è ID extraction failed.");
          alert("‚úÖ ID not found");
          //window.location.href = "https://process.qrtagall.com";
          return;
        }

        /*
         const secondOAuthUrl = `https://accounts.google.com/o/oauth2/v2/auth` +
                `?response_type=token` +
                `&client_id=121290253918-e3qk9a1qao4r4r89s52lcq79evcbbes2.apps.googleusercontent.com` +
                `&redirect_uri=${encodeURIComponent('https://process.qrtagall.com/oauth-redirect-final.html')}` +
                `&scope=${encodeURIComponent('https://www.googleapis.com/auth/userinfo.email')}` +
                `&state=${encodeURIComponent(finalRedirectUrl)}`;
              
              console.log("üîÅ Redirecting to second OAuth flow:", secondOAuthUrl);
              window.location.href = secondOAuthUrl;
              */
        console.log("Timeout Triggered>>1");
        const finalRedirectUrl = `https://process.qrtagall.com/?id=${id}`;

        const secondOAuthUrl = `https://accounts.google.com/o/oauth2/v2/auth` +
          `?response_type=token` +
          `&client_id=121290253918-e3qk9a1qao4r4r89s52lcq79evcbbes2.apps.googleusercontent.com` +
          `&redirect_uri=${encodeURIComponent('https://process.qrtagall.com/oauth-redirect-final.html')}` +
          `&scope=${encodeURIComponent('https://www.googleapis.com/auth/userinfo.email')}` +
          `&state=${encodeURIComponent(finalRedirectUrl)}`;

        console.log("üîÅ Triggering second OAuth escape:", secondOAuthUrl);
        window.location.href = secondOAuthUrl;

      } catch (e) {
        console.error("‚ùå Error during final redirect setup:", e);
        window.location.href = "https://process.qrtagall.com";
      }
    }, 10000); // Wait 8 seconds before escaping Apps Script

  } catch (error) {
    console.error("‚ùå Critical Error:", error);
    document.getElementById("status").textContent = "‚ùå Save Failed.";
    window.location.href = "https://process.qrtagall.com";
  }
})();
</script>

</body>
</html>
