<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üîÑ Saving Artifact...</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f4f4;
      text-align: center;
      padding-top: 80px;
      color: #333;
    }
    .spinner {
      margin-top: 20px;
      font-size: 22px;
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0% { opacity: 0.2; }
      50% { opacity: 1; }
      100% { opacity: 0.2; }
    }
    .info {
      font-size: 14px;
      color: #777;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>üîê Saving Artifact (v-1)</h2>
  <p class="info" id="status">Just a moment while we save your artifact...</p>
  <div class="spinner">‚è≥</div>

<script>

  (async function() {
  try {
    const params = new URLSearchParams(window.location.hash.substring(1));
    const accessToken = params.get("access_token");
    const rawState = params.get("state") || "";
    const saveUrl = decodeURIComponent(rawState);

    const statusEl = document.getElementById("status");

    if (!saveUrl || !accessToken) {
      statusEl.textContent = "‚ùå Missing information.";
      return;
    }

    console.log("‚úÖ Save URL received:", saveUrl);

    // ‚úÖ Validate accessToken
    const userInfoRes = await fetch("https://www.googleapis.com/oauth2/v3/userinfo", {
      headers: { Authorization: `Bearer ${accessToken}` }
    });
    const userInfo = await userInfoRes.json();
    if (!userInfo.email) {
      throw new Error("‚ùå No email received");
    }
    console.log("üìß Email:", userInfo.email);

    // ‚úÖ Now save artifact via FETCH, not window.location
    const saveRes = await fetch(saveUrl, {
      method: "GET",
      headers: {
        Authorization: `Bearer ${accessToken}`
      }
    });

    const saveData = await saveRes.json();
    console.log("üìù Save Result:", saveData);

    if (!saveData.success) {
      throw new Error(saveData.message || "Artifact save failed.");
    }

    // ‚úÖ After save, proceed
    setTimeout(() => {
      const idMatch = saveUrl.match(/[?&]id=([^&]+)/);
      const id = idMatch ? idMatch[1] : null;

      const finalRedirectUrl = id 
        ? `https://process.qrtagall.com/?id=${id}`
        : "https://process.qrtagall.com";

      const secondOAuthUrl = `https://accounts.google.com/o/oauth2/v2/auth` +
          `?response_type=token` +
          `&client_id=121290253918-e3qk9a1qao4r4r89s52lcq79evcbbes2.apps.googleusercontent.com` +
          `&redirect_uri=${encodeURIComponent('https://process.qrtagall.com/oauth-redirect-final.html')}` +
          `&scope=${encodeURIComponent('https://www.googleapis.com/auth/userinfo.email')}` +
          `&state=${encodeURIComponent(finalRedirectUrl)}`;

      console.log("üîÅ Second OAuth Trigger:", secondOAuthUrl);
      window.location.href = secondOAuthUrl;
    }, 5000);

  } catch (error) {
    console.error("‚ùå Error:", error);
    document.getElementById("status").textContent = "‚ùå Save Failed.";
    setTimeout(() => {
      window.location.href = "https://process.qrtagall.com";
    }, 1500);
  }
})();


</script>

</body>
</html>
