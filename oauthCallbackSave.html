<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üîÑ Saving Artifact...</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f4f4;
      text-align: center;
      padding-top: 80px;
      color: #333;
    }
    .spinner {
      margin-top: 20px;
      font-size: 22px;
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0% { opacity: 0.2; }
      50% { opacity: 1; }
      100% { opacity: 0.2; }
    }
    .info {
      font-size: 14px;
      color: #777;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>üîê Saving Artifact (v-1)</h2>
  <p class="info" id="status">Just a moment while we save your artifact...</p>
  <div class="spinner">‚è≥</div>

<script>
(async function() {
  try {
    const params = new URLSearchParams(window.location.hash.substring(1));
    const accessToken = params.get("access_token");
    const rawState = params.get("state") || "";
    const saveUrl = decodeURIComponent(rawState);

    const statusEl = document.getElementById("status");

    if (!saveUrl || !accessToken) {
      statusEl.textContent = "‚ùå Missing information.";
      return;
    }

    console.log("‚úÖ Save URL received:", saveUrl);

    // ‚úÖ‚úÖ‚úÖ Verify the accessToken FIRST like in claim flow
    const userInfoRes = await fetch("https://www.googleapis.com/oauth2/v3/userinfo", {
      headers: { Authorization: `Bearer ${accessToken}` }
    });
    const userInfo = await userInfoRes.json();
    if (!userInfo.email) {
      throw new Error("‚ùå No email received, invalid token");
    }
    console.log("üìß Email fetched for validation:", userInfo.email);

    // ‚úÖ After validation, now safe to redirect
    window.location.href = saveUrl;

    // (Your setTimeout block here after redirect...)

  } catch (error) {
    console.error("‚ùå Critical Error:", error);
    document.getElementById("status").textContent = "‚ùå Save Failed.";
    window.location.href = "https://process.qrtagall.com";
  }
})();

</script>

</body>
</html>
